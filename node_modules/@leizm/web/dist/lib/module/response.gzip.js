"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.responseGzip = void 0;
const zlib_1 = require("zlib");
/**
 * @leizm/web 中间件基础框架 - 内置模块
 * @author Zongmin Lei <leizongmin@gmail.com>
 */
/**
 * 响应压缩的内容
 *
 * @param req
 * @param res
 * @param data
 * @param contentType
 */
function responseGzip(req, res, data, contentType) {
    let zlibStream;
    let encoding = req.headers["content-encoding"];
    switch (encoding) {
        case "gzip":
            zlibStream = zlib_1.createGzip();
            break;
        case "deflate":
            zlibStream = zlib_1.createDeflate();
            break;
        case "deflate-raw":
            zlibStream = zlib_1.createDeflateRaw();
            break;
        default:
            encoding = "gzip";
            zlibStream = zlib_1.createGzip();
    }
    if (contentType) {
        res.setHeader("Content-Type", contentType);
    }
    res.setHeader("Content-Encoding", encoding);
    zlibStream.pipe(res);
    if (typeof data === "string") {
        zlibStream.end(data);
    }
    else if (Buffer.isBuffer(data)) {
        zlibStream.end(data);
    }
    else {
        data.pipe(zlibStream);
    }
    zlibStream.on("error", (err) => {
        res.writeHead(500, { "Content-Type": "text/plain" });
        res.end(`ctx.response.gzip(): ${err.message}`);
    });
}
exports.responseGzip = responseGzip;
